<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:models="clr-namespace:KamPay.Models"
             x:Class="KamPay.Views.ChatPage"
             Title="{Binding CurrentConversation.OtherUserName}">

    <Grid>

        <!-- AsÄ±l iÃ§erik -->
        <Grid RowDefinitions="*,Auto">

            <CollectionView Grid.Row="0"
                            x:Name="MessagesCollectionView"
                            ItemsSource="{Binding Messages}"
                            ItemsLayout="VerticalList"
                            VerticalScrollBarVisibility="Never"
                            SelectionMode="None">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Message">
                        <Grid Padding="10,5">
                            <Frame Padding="12"
                                   CornerRadius="15"
                                   BorderColor="Transparent"
                                   HasShadow="False"
                                   MaximumWidthRequest="280">
                                <Frame.Style>
                                    <Style TargetType="Frame">
                                        <Setter Property="HorizontalOptions" Value="Start" />
                                        <Setter Property="BackgroundColor" Value="#E0E0E0" />
                                        <Style.Triggers>
                                            <DataTrigger TargetType="Frame"
                                                         Binding="{Binding IsSentByMe}"
                                                         Value="True">
                                                <Setter Property="HorizontalOptions" Value="End" />
                                                <Setter Property="BackgroundColor"
                                                        Value="{StaticResource Primary}" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Frame.Style>

                                <VerticalStackLayout Spacing="5">
                                    <Label Text="{Binding Content}"
                                           LineBreakMode="WordWrap">
                                        <Label.Style>
                                            <Style TargetType="Label">
                                                <Setter Property="TextColor" Value="Black" />
                                                <Style.Triggers>
                                                    <DataTrigger TargetType="Label"
                                                                 Binding="{Binding IsSentByMe}"
                                                                 Value="True">
                                                        <Setter Property="TextColor" Value="White" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Label.Style>
                                    </Label>

                                    <!-- Zaman ve Durum GÃ¶stergesi -->
                                    <HorizontalStackLayout Spacing="5" HorizontalOptions="End">
                                        <Label Text="{Binding TimeText}"
                                               FontSize="10">
                                            <Label.Style>
                                                <Style TargetType="Label">
                                                    <Setter Property="TextColor"
                                                            Value="{StaticResource Gray}" />
                                                    <Style.Triggers>
                                                        <DataTrigger TargetType="Label"
                                                                     Binding="{Binding IsSentByMe}"
                                                                     Value="True">
                                                            <Setter Property="TextColor"
                                                                    Value="#B2DFDB" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Label.Style>
                                        </Label>

                                        <!-- ðŸ”¥ YENÄ°: GÃ¶nderim durumu (sadece kendi mesajlarÄ±nda) -->
                                        <Label FontSize="12"
                                               IsVisible="{Binding IsSentByMe}"
                                               TextColor="#B2DFDB">
                                            <Label.Triggers>
                                                <DataTrigger TargetType="Label" 
                                                            Binding="{Binding IsDelivered}" 
                                                            Value="False">
                                                    <Setter Property="Text" Value="â±" />
                                                </DataTrigger>
                                                <DataTrigger TargetType="Label" 
                                                            Binding="{Binding IsDelivered}" 
                                                            Value="True">
                                                    <Setter Property="Text" Value="âœ“âœ“" />
                                                </DataTrigger>
                                            </Label.Triggers>
                                        </Label>
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>
                            </Frame>
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <Frame Grid.Row="1"
                   Padding="10"
                   CornerRadius="0"
                   BorderColor="#E0E0E0"
                   BackgroundColor="White">
                <Grid ColumnDefinitions="*,Auto"
                      ColumnSpacing="10">
                    <Entry Grid.Column="0"
                           Placeholder="MesajÄ±nÄ±zÄ± yazÄ±n..."
                           Text="{Binding MessageText}"
                           ReturnCommand="{Binding SendMessageCommand}" />
                    <Button Grid.Column="1"
                            Text="GÃ¶nder"
                            Command="{Binding SendMessageCommand}"
                            IsEnabled="{Binding IsSending, Converter={StaticResource InvertedBoolConverter}}"
                            WidthRequest="80" />
                </Grid>
            </Frame>
        </Grid>

        <!-- ðŸ”¹ YÃ¼kleme KatmanÄ± (Overlay) -->
        <Grid IsVisible="{Binding IsLoading}"
              BackgroundColor="#80000000"
              InputTransparent="False">
            <VerticalStackLayout VerticalOptions="Center"
                                 HorizontalOptions="Center"
                                 Spacing="10">
                <ActivityIndicator IsRunning="True"
                                   Color="White"
                                   WidthRequest="50"
                                   HeightRequest="50" />
                <Label Text="YÃ¼kleniyor..."
                       TextColor="White"
                       FontSize="14"
                       HorizontalTextAlignment="Center" />
            </VerticalStackLayout>
        </Grid>

    </Grid>
</ContentPage>