<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:KamPay.ViewModels"
             x:DataType="vm:SurpriseBoxViewModel"
             x:Class="KamPay.Views.SurpriseBoxPage"
             Title="Sürpriz Kutu">

    <Grid RowDefinitions="*, Auto" Padding="20">

        <VerticalStackLayout Grid.Row="0"
                             VerticalOptions="Center"
                             HorizontalOptions="Center"
                             Spacing="20">

            <!-- 🔥 Mevcut Puan Göstergesi -->
            <Frame BackgroundColor="#4CAF50" 
                   CornerRadius="20" 
                   Padding="15,10"
                   HasShadow="True">
                <HorizontalStackLayout Spacing="10">
                    <Label Text="💰" FontSize="24"/>
                    <Label Text="{Binding UserPoints, StringFormat='Puanınız: {0}'}" 
                           FontSize="18" 
                           FontAttributes="Bold"
                           TextColor="White"/>
                </HorizontalStackLayout>
            </Frame>

            <Image x:Name="BoxImage"
                   Source="gift_box.png" 
                   WidthRequest="150"
                   HeightRequest="150">
                <Image.GestureRecognizers>
                    <TapGestureRecognizer Command="{Binding RedeemBoxCommand}" />
                </Image.GestureRecognizers>
            </Image>

            <Label Text="Sürpriz Kutu!"
                   FontSize="32"
                   FontAttributes="Bold"
                   HorizontalTextAlignment="Center"/>

            <Label Text="100 puan karşılığında bir sürpriz kutu açarak bağışlanmış ürünlerden birini kazanma şansı yakala!"
                   HorizontalTextAlignment="Center"
                   TextColor="Gray"
                   Margin="20,0"/>

            <!-- Sonuç Frame'i -->
            <Frame x:Name="ResultFrame"
                   IsVisible="False"
                   Padding="15"
                   CornerRadius="15"
                   BorderColor="{StaticResource Primary}"
                   BackgroundColor="#F5F5F5"
                   HasShadow="True">
                <VerticalStackLayout Spacing="10">
                    <Label Text="🎉 Tebrikler! 🎉"
                           FontSize="24"
                           FontAttributes="Bold"
                           TextColor="{StaticResource Primary}"
                           HorizontalTextAlignment="Center"/>

                    <Image Source="{Binding RedemptionResult.ThumbnailUrl}"
                           HeightRequest="150"
                           Aspect="AspectFit"
                           Margin="0,10"/>

                    <Label Text="{Binding RedemptionResult.Title}"
                           FontSize="18"
                           FontAttributes="Bold"
                           HorizontalTextAlignment="Center"/>

                    <!-- 🔥 YENİ: Başarı mesajı -->
                    <Label Text="{Binding SuccessMessage}"
                           TextColor="{StaticResource Primary}"
                           HorizontalTextAlignment="Center"
                           Margin="10,0"/>

                    <Button Text="Harika! Ürünüme Git"
                            Clicked="CloseResult_Clicked"
                            BackgroundColor="{StaticResource Primary}"
                            Margin="0,10,0,0"/>
                </VerticalStackLayout>
            </Frame>

        </VerticalStackLayout>

        <VerticalStackLayout Grid.Row="1" Spacing="10">
            <Label Text="{Binding ErrorMessage}"
                   TextColor="Red"
                   HorizontalTextAlignment="Center"
                   IsVisible="{Binding HasError}" />

            <Button Command="{Binding RedeemBoxCommand}"
                    Text="🎁 100 Puana Kutu Aç!"
                    IsEnabled="{Binding CanRedeem}"
                    HeightRequest="50"
                    BackgroundColor="{StaticResource Primary}"
                    FontAttributes="Bold" />

            <!-- 🔥 YENİ: Yeterli puan uyarısı -->
            <Label Text="⚠️ Yetersiz puan! Daha fazla puan kazanmak için takas yapabilirsiniz."
                   TextColor="Orange"
                   FontSize="12"
                   HorizontalTextAlignment="Center"
                   IsVisible="{Binding UserPoints, Converter={StaticResource LessThan100Converter}}"/>
        </VerticalStackLayout>

        <ActivityIndicator IsRunning="{Binding IsLoading}" 
                           VerticalOptions="Center" 
                           HorizontalOptions="Center"
                           Color="{StaticResource Primary}" />
    </Grid>
</ContentPage>